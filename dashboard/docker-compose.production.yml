services:
  dashboard:
    image: node:20-alpine
    container_name: 3a-dashboard
    restart: always
    working_dir: /app
    labels:
      - traefik.enable=true
      - traefik.http.routers.dashboard.rule=Host(`dashboard.3a-automation.com`)
      - traefik.http.routers.dashboard.tls=true
      - traefik.http.routers.dashboard.entrypoints=web,websecure
      - traefik.http.routers.dashboard.tls.certresolver=mytlschallenge
      - traefik.http.services.dashboard.loadbalancer.server.port=3000
      # Security Headers Middleware
      - traefik.http.routers.dashboard.middlewares=dashboard-security@docker
      - traefik.http.middlewares.dashboard-security.headers.stsSeconds=31536000
      - traefik.http.middlewares.dashboard-security.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.dashboard-security.headers.stsPreload=true
      - traefik.http.middlewares.dashboard-security.headers.frameDeny=true
      - traefik.http.middlewares.dashboard-security.headers.contentTypeNosniff=true
      - traefik.http.middlewares.dashboard-security.headers.browserXssFilter=true
      - traefik.http.middlewares.dashboard-security.headers.referrerPolicy=strict-origin-when-cross-origin
      - traefik.http.middlewares.dashboard-security.headers.permissionsPolicy=camera=(), microphone=(self), geolocation=(), payment=()
      - traefik.http.middlewares.dashboard-security.headers.contentSecurityPolicy=default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://script.google.com https://n8n.srv1168256.hstgr.cloud https://www.google-analytics.com
    networks:
      - root_default
    env_file:
      - .env.production
    environment:
      - NODE_ENV=production
      - PORT=3000
      - GOOGLE_SHEETS_ID=${GOOGLE_SHEETS_ID}
      - GOOGLE_SHEETS_API_URL=${GOOGLE_SHEETS_API_URL}
      - JWT_SECRET=${JWT_SECRET}
      - NEXT_PUBLIC_SITE_URL=https://dashboard.3a-automation.com
      - N8N_HOST=https://n8n.srv1168256.hstgr.cloud
      - N8N_API_KEY=${N8N_API_KEY}
    command: >
      sh -c '
        apk add --no-cache git &&
        rm -rf /app/* /app/.next /app/node_modules 2>/dev/null || true &&
        git clone --depth 1 https://github.com/Jouiet/3a-automations.git /tmp/repo &&
        cp -r /tmp/repo/dashboard/* /app/ &&
        rm -rf /tmp/repo &&
        npm cache clean --force &&
        npm install --legacy-peer-deps &&
        npm run build &&
        npm run start
      '
    volumes:
      - dashboard_node_modules:/app/node_modules
      - dashboard_next:/app/.next

networks:
  root_default:
    external: true

volumes:
  dashboard_node_modules:
  dashboard_next:
