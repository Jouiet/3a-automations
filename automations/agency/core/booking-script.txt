/**
 * 3A Automation - Google Apps Script Booking System
 * @version 1.0.1
 * @date 2025-12-20
 */

var CONFIG = {
  CALENDAR_ID: "primary",
  TIMEZONE: "Africa/Casablanca",
  SLOT_DURATION: 30,
  NOTIFICATION_EMAIL: "contact@3a-automation.com",
  BUSINESS_HOURS: {
    1: { start: 9, end: 18 },
    2: { start: 9, end: 18 },
    3: { start: 9, end: 18 },
    4: { start: 9, end: 18 },
    5: { start: 9, end: 18 },
    6: null,
    0: null
  }
};

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);

    if (!data.name || !data.email || !data.datetime) {
      return createResponse(false, "Missing required fields");
    }

    var startTime = new Date(data.datetime);
    var endTime = new Date(startTime.getTime() + CONFIG.SLOT_DURATION * 60000);

    if (!isSlotAvailable(startTime, endTime)) {
      return createResponse(false, "Slot not available");
    }

    var event = createCalendarEvent({
      name: data.name,
      email: data.email,
      phone: data.phone || "",
      service: data.service || "Consultation",
      notes: data.notes || "",
      startTime: startTime,
      endTime: endTime
    });

    sendConfirmationEmail(data, startTime);
    sendAdminNotification(data, startTime);

    return createResponse(true, "Booking confirmed", {
      eventId: event.getId(),
      datetime: startTime.toISOString(),
      name: data.name,
      email: data.email
    });

  } catch (error) {
    return createResponse(false, "Error: " + error.message);
  }
}

function doGet(e) {
  try {
    var action = e.parameter.action || "availability";

    if (action === "availability") {
      var slots = getAvailableSlots(14);
      return createResponse(true, "OK", { slots: slots, count: slots.length });
    }

    if (action === "health") {
      return createResponse(true, "OK", {
        service: "3A Booking",
        version: "1.0.1",
        timestamp: new Date().toISOString()
      });
    }

    return createResponse(false, "Unknown action");

  } catch (error) {
    return createResponse(false, "Error: " + error.message);
  }
}

function isSlotAvailable(startTime, endTime) {
  var calendar = CalendarApp.getCalendarById(CONFIG.CALENDAR_ID) || CalendarApp.getDefaultCalendar();
  var events = calendar.getEvents(startTime, endTime);

  var dayOfWeek = startTime.getDay();
  var hours = CONFIG.BUSINESS_HOURS[dayOfWeek];

  if (!hours) return false;

  var startHour = startTime.getHours();
  var endHour = endTime.getHours();

  if (startHour < hours.start || endHour > hours.end) {
    return false;
  }

  return events.length === 0;
}

function getAvailableSlots(days) {
  var calendar = CalendarApp.getCalendarById(CONFIG.CALENDAR_ID) || CalendarApp.getDefaultCalendar();
  var slots = [];
  var now = new Date();

  for (var d = 1; d <= days; d++) {
    var date = new Date(now);
    date.setDate(now.getDate() + d);
    date.setHours(0, 0, 0, 0);

    var dayOfWeek = date.getDay();
    var hours = CONFIG.BUSINESS_HOURS[dayOfWeek];

    if (!hours) continue;

    var dayStart = new Date(date);
    dayStart.setHours(hours.start, 0, 0, 0);

    var dayEnd = new Date(date);
    dayEnd.setHours(hours.end, 0, 0, 0);

    var events = calendar.getEvents(dayStart, dayEnd);

    for (var h = hours.start; h < hours.end; h++) {
      for (var m = 0; m < 60; m += CONFIG.SLOT_DURATION) {
        var slotStart = new Date(date);
        slotStart.setHours(h, m, 0, 0);

        var slotEnd = new Date(slotStart.getTime() + CONFIG.SLOT_DURATION * 60000);

        var isAvailable = true;
        for (var i = 0; i < events.length; i++) {
          var eventStart = events[i].getStartTime();
          var eventEnd = events[i].getEndTime();
          if (slotStart < eventEnd && slotEnd > eventStart) {
            isAvailable = false;
            break;
          }
        }

        if (isAvailable && slotEnd.getHours() <= hours.end) {
          slots.push({
            date: Utilities.formatDate(slotStart, CONFIG.TIMEZONE, "yyyy-MM-dd"),
            time: Utilities.formatDate(slotStart, CONFIG.TIMEZONE, "HH:mm"),
            start: slotStart.toISOString(),
            end: slotEnd.toISOString(),
            dayName: Utilities.formatDate(slotStart, CONFIG.TIMEZONE, "EEEE")
          });
        }
      }
    }
  }

  return slots;
}

function createCalendarEvent(booking) {
  var calendar = CalendarApp.getCalendarById(CONFIG.CALENDAR_ID) || CalendarApp.getDefaultCalendar();

  var title = "RDV: " + booking.name + " - " + booking.service;
  var description = "Client: " + booking.name + "\n" +
    "Email: " + booking.email + "\n" +
    "Phone: " + (booking.phone || "N/A") + "\n" +
    "Service: " + booking.service + "\n" +
    "Notes: " + (booking.notes || "None") + "\n\n" +
    "---\n3A Automation\nhttps://3a-automation.com";

  var event = calendar.createEvent(title, booking.startTime, booking.endTime, {
    description: description,
    guests: booking.email,
    sendInvites: true
  });

  event.addPopupReminder(30);
  event.addEmailReminder(1440);

  return event;
}

function sendConfirmationEmail(booking, datetime) {
  var dateStr = Utilities.formatDate(datetime, CONFIG.TIMEZONE, "EEEE d MMMM yyyy");
  var timeStr = Utilities.formatDate(datetime, CONFIG.TIMEZONE, "HH:mm");

  var subject = "Confirmation RDV - 3A Automation - " + dateStr;

  var body = "Bonjour " + booking.name + ",\n\n" +
    "Votre rendez-vous est confirme!\n\n" +
    "Date: " + dateStr + "\n" +
    "Heure: " + timeStr + " (30 minutes)\n" +
    "Service: " + (booking.service || "Consultation") + "\n\n" +
    "A bientot!\n\n" +
    "---\n3A Automation\nhttps://3a-automation.com";

  try {
    MailApp.sendEmail({
      to: booking.email,
      subject: subject,
      body: body,
      name: "3A Automation"
    });
  } catch (err) {
    Logger.log("Email error: " + err);
  }
}

function sendAdminNotification(booking, datetime) {
  var dateStr = Utilities.formatDate(datetime, CONFIG.TIMEZONE, "EEEE d MMMM yyyy HH:mm");

  var subject = "[3A] Nouveau RDV: " + booking.name;

  var body = "Nouveau rendez-vous!\n\n" +
    "Client: " + booking.name + "\n" +
    "Email: " + booking.email + "\n" +
    "Phone: " + (booking.phone || "N/A") + "\n" +
    "Service: " + (booking.service || "Consultation") + "\n" +
    "Date: " + dateStr + "\n" +
    "Notes: " + (booking.notes || "None");

  try {
    MailApp.sendEmail({
      to: CONFIG.NOTIFICATION_EMAIL,
      subject: subject,
      body: body
    });
  } catch (err) {
    Logger.log("Admin notification error: " + err);
  }
}

function createResponse(success, message, data) {
  var response = {
    success: success,
    message: message,
    timestamp: new Date().toISOString()
  };

  if (data) {
    response.data = data;
  }

  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

function testSetup() {
  var calendar = CalendarApp.getDefaultCalendar();
  Logger.log("Calendar: " + calendar.getName());
  Logger.log("ID: " + calendar.getId());
  var slots = getAvailableSlots(7);
  Logger.log("Slots (7 days): " + slots.length);
  var quota = MailApp.getRemainingDailyQuota();
  Logger.log("Email quota: " + quota);
  Logger.log("Test complete!");
}
