!function(){"use strict";const e="Bonjour ! Je suis l'assistant 3A Automation. Comment puis-je vous aider ?",n="Bonjour ! Je suis l'assistant 3A Automation. Posez votre question par écrit, je vous réponds instantanément.",t="Posez votre question...",o="#4FBAF1",s="#2B6685",a="#10B981",i="#191E35",r=!1,c="wss://voice-api.3a-automation.com/realtime",l="ws://localhost:3007",u="ara",d=!0,p="https://voice-api.3a-automation.com/respond",m={ws:null,connected:!1,audioContext:null,audioQueue:[],isPlaying:!1,onTranscript:null,onAIResponse:null,onError:null,base64ToFloat32(e){const n=atob(e),t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);const o=new Int16Array(t.buffer),s=new Float32Array(o.length);for(let e=0;e<o.length;e++)s[e]=o[e]/32768;return s},async connect(){return new Promise(((e,n)=>{const t=`${c}?voice=${u}`;console.log("[Realtime] Connecting to proxy...");try{this.ws=new WebSocket(t)}catch(e){try{this.ws=new WebSocket(`${l}?voice=${u}`)}catch(e){return void n(new Error("WebSocket connection failed"))}}const o=setTimeout((()=>{n(new Error("Connection timeout"))}),5e3);this.ws.onopen=()=>{clearTimeout(o),console.log("[Realtime] Connected"),this.connected=!0,e()},this.ws.onmessage=e=>this.handleMessage(e.data),this.ws.onerror=e=>{clearTimeout(o),console.error("[Realtime] Error:",e),this.onError&&this.onError(e),this.connected||n(e)},this.ws.onclose=()=>{console.log("[Realtime] Disconnected"),this.connected=!1}}))},handleMessage(e){try{const n=JSON.parse(e);switch(n.type){case"proxy.connected":console.log("[Realtime] Session:",n.sessionId);break;case"conversation.item.input_audio_transcription.completed":this.onTranscript&&this.onTranscript(n.transcript);break;case"response.audio.delta":this.audioQueue.push(n.delta),this.processAudioQueue();break;case"response.audio_transcript.done":this.onAIResponse&&this.onAIResponse(n.transcript);break;case"error":console.error("[Realtime] Error:",n.error),this.onError&&this.onError(new Error(n.error?.message||"Unknown error"))}}catch(e){console.error("[Realtime] Parse error:",e)}},async processAudioQueue(){if(!this.isPlaying&&0!==this.audioQueue.length){for(this.isPlaying=!0,this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}));this.audioQueue.length>0;){const e=this.audioQueue.shift(),n=this.base64ToFloat32(e),t=this.audioContext.createBuffer(1,n.length,24e3);t.getChannelData(0).set(n);const o=this.audioContext.createBufferSource();o.buffer=t,o.connect(this.audioContext.destination),o.start(),await new Promise((e=>{o.onended=e}))}this.isPlaying=!1}},sendText(e){return!!this.connected&&(this.ws.send(JSON.stringify({type:"proxy.text",text:e})),!0)},disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.connected=!1,this.audioQueue=[]},isSupported:()=>"WebSocket"in window&&"AudioContext"in window};let v=!1,g=!1,f=null;function h(e,n={}){"function"==typeof gtag&&gtag("event",e,{event_category:"voice_assistant",...n}),"undefined"!=typeof dataLayer&&Array.isArray(dataLayer)&&dataLayer.push({event:e,event_category:"voice_assistant",...n})}!async function(){try{const e=await fetch("/voice-assistant/knowledge.json");e.ok&&(f=await e.json(),console.log("Knowledge base loaded:",f.totalAutomations,"automations"))}catch(e){console.log("Knowledge base not available, using defaults")}}();let b=!1,y=!1,x=null,w=window.speechSynthesis,k=[];const E="SpeechRecognition"in window||"webkitSpeechRecognition"in window,z="speechSynthesis"in window,S=navigator.userAgent.toLowerCase().includes("firefox"),A=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),P=!E||S||A;function T(){const e=document.createElement("div");e.id="voice-assistant-widget",e.style.cssText="position:fixed;bottom:140px;right:20px;z-index:99999;font-family:Inter,-apple-system,BlinkMacSystemFont,sans-serif;",e.innerHTML=`\n      <style>\n        #voice-assistant-widget {\n          --va-primary: ${o};\n          --va-primary-dark: ${s};\n          --va-accent: ${a};\n          --va-dark: ${i};\n          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n          position: fixed;\n          bottom: 140px;\n          right: 20px;\n          z-index: 99999;\n        }\n\n        .va-trigger {\n          width: 60px;\n          height: 60px;\n          border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          border: none;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          box-shadow: 0 4px 20px rgba(79, 186, 241, 0.4);\n          transition: all 0.3s ease;\n          position: relative;\n          animation: pulse-glow 2s ease-in-out infinite;\n        }\n\n        .va-trigger::before {\n          content: '';\n          position: absolute;\n          top: -4px;\n          left: -4px;\n          right: -4px;\n          bottom: -4px;\n          border-radius: 50%;\n          background: linear-gradient(135deg, var(--va-primary), var(--va-accent));\n          opacity: 0;\n          z-index: -1;\n          animation: pulse-ring 2s ease-out infinite;\n        }\n\n        .va-trigger::after {\n          content: '';\n          position: absolute;\n          top: -8px;\n          left: -8px;\n          right: -8px;\n          bottom: -8px;\n          border-radius: 50%;\n          border: 2px solid var(--va-primary);\n          opacity: 0;\n          animation: pulse-ring-outer 2s ease-out infinite 0.5s;\n        }\n\n        @keyframes pulse-glow {\n          0%, 100% { box-shadow: 0 4px 20px rgba(79, 186, 241, 0.4); transform: scale(1); }\n          50% { box-shadow: 0 4px 30px rgba(79, 186, 241, 0.7); transform: scale(1.02); }\n        }\n\n        @keyframes pulse-ring {\n          0% { transform: scale(1); opacity: 0.6; }\n          100% { transform: scale(1.4); opacity: 0; }\n        }\n\n        @keyframes pulse-ring-outer {\n          0% { transform: scale(1); opacity: 0.4; }\n          100% { transform: scale(1.6); opacity: 0; }\n        }\n\n        .va-trigger:hover {\n          transform: scale(1.1);\n          box-shadow: 0 6px 30px rgba(79, 186, 241, 0.6);\n          animation: none;\n        }\n\n        .va-trigger:hover::before,\n        .va-trigger:hover::after {\n          animation: none;\n          opacity: 0;\n        }\n\n        .va-trigger img {\n          width: 40px;\n          height: 40px;\n          object-fit: contain;\n          border-radius: 8px;\n        }\n\n        .va-trigger.listening {\n          animation: pulse 1.5s infinite;\n        }\n\n        @keyframes pulse {\n          0%, 100% { box-shadow: 0 0 0 0 rgba(79, 186, 241, 0.7); }\n          50% { box-shadow: 0 0 0 15px rgba(79, 186, 241, 0); }\n        }\n\n        .va-panel {\n          display: none;\n          position: absolute;\n          bottom: 70px;\n          right: 0;\n          width: 360px;\n          max-height: 500px;\n          background: var(--va-dark);\n          border: 1px solid rgba(255,255,255,0.1);\n          border-radius: 16px;\n          overflow: hidden;\n          box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n        }\n\n        .va-panel.open {\n          display: flex;\n          flex-direction: column;\n          animation: slideUp 0.3s ease;\n        }\n\n        @keyframes slideUp {\n          from { opacity: 0; transform: translateY(20px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n\n        .va-header {\n          padding: 16px;\n          background: linear-gradient(135deg, var(--va-primary) 0%, var(--va-primary-dark) 50%, var(--va-accent) 100%);\n          display: flex;\n          align-items: center;\n          gap: 12px;\n        }\n\n        .va-header-icon {\n          width: 40px;\n          height: 40px;\n          background: rgba(255,255,255,0.2);\n          border-radius: 50%;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n\n        .va-header-icon svg {\n          width: 24px;\n          height: 24px;\n          fill: white;\n        }\n\n        .va-header-text h3 {\n          margin: 0;\n          font-size: 16px;\n          font-weight: 600;\n          color: white;\n        }\n\n        .va-header-text p {\n          margin: 2px 0 0;\n          font-size: 12px;\n          color: rgba(255,255,255,0.8);\n        }\n\n        .va-close {\n          margin-left: auto;\n          background: none;\n          border: none;\n          color: white;\n          cursor: pointer;\n          padding: 4px;\n          opacity: 0.8;\n        }\n\n        .va-close:hover {\n          opacity: 1;\n        }\n\n        .va-messages {\n          flex: 1;\n          overflow-y: auto;\n          padding: 16px;\n          max-height: 300px;\n        }\n\n        .va-message {\n          margin-bottom: 12px;\n          display: flex;\n          gap: 8px;\n        }\n\n        .va-message.user {\n          flex-direction: row-reverse;\n        }\n\n        .va-message-content {\n          max-width: 80%;\n          padding: 10px 14px;\n          border-radius: 12px;\n          font-size: 14px;\n          line-height: 1.4;\n        }\n\n        .va-message.assistant .va-message-content {\n          background: rgba(255,255,255,0.1);\n          color: #e5e5e5;\n        }\n\n        .va-message.user .va-message-content {\n          background: var(--va-primary);\n          color: white;\n        }\n\n        .va-input-area {\n          padding: 12px 16px;\n          border-top: 1px solid rgba(255,255,255,0.1);\n          display: flex;\n          gap: 8px;\n        }\n\n        .va-input {\n          flex: 1;\n          background: rgba(255,255,255,0.1);\n          border: 1px solid rgba(255,255,255,0.1);\n          border-radius: 24px;\n          padding: 10px 16px;\n          color: white;\n          font-size: 14px;\n          outline: none;\n        }\n\n        .va-input::placeholder {\n          color: rgba(255,255,255,0.5);\n        }\n\n        .va-input:focus {\n          border-color: var(--va-primary);\n        }\n\n        .va-mic-btn {\n          width: 40px;\n          height: 40px;\n          border-radius: 50%;\n          background: ${E?"var(--va-primary)":"rgba(255,255,255,0.1)"};\n          border: none;\n          cursor: ${E?"pointer":"not-allowed"};\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          transition: all 0.2s;\n        }\n\n        .va-mic-btn:hover {\n          ${E?"transform: scale(1.1);":""}\n        }\n\n        .va-mic-btn.listening {\n          background: #ef4444;\n          animation: pulse 1s infinite;\n        }\n\n        .va-mic-btn svg {\n          width: 20px;\n          height: 20px;\n          fill: white;\n        }\n\n        .va-send-btn {\n          width: 40px;\n          height: 40px;\n          border-radius: 50%;\n          background: var(--va-primary);\n          border: none;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          transition: all 0.2s;\n        }\n\n        .va-send-btn:hover {\n          transform: scale(1.1);\n        }\n\n        .va-send-btn svg {\n          width: 20px;\n          height: 20px;\n          fill: white;\n        }\n\n        .va-typing {\n          display: flex;\n          gap: 4px;\n          padding: 10px 14px;\n        }\n\n        .va-typing span {\n          width: 8px;\n          height: 8px;\n          background: rgba(255,255,255,0.5);\n          border-radius: 50%;\n          animation: typing 1.4s infinite ease-in-out;\n        }\n\n        .va-typing span:nth-child(2) { animation-delay: 0.2s; }\n        .va-typing span:nth-child(3) { animation-delay: 0.4s; }\n\n        @keyframes typing {\n          0%, 60%, 100% { transform: translateY(0); }\n          30% { transform: translateY(-6px); }\n        }\n\n        .va-cta {\n          padding: 12px 16px;\n          background: rgba(79, 186, 241, 0.1);\n          border-top: 1px solid rgba(79, 186, 241, 0.2);\n        }\n\n        .va-cta a {\n          display: block;\n          text-align: center;\n          padding: 10px;\n          background: var(--va-primary);\n          color: white;\n          text-decoration: none;\n          border-radius: 8px;\n          font-size: 14px;\n          font-weight: 500;\n          transition: all 0.2s;\n        }\n\n        .va-cta a:hover {\n          background: var(--va-primary-dark);\n        }\n\n        @keyframes fadeIn {\n          from { opacity: 0; transform: translateY(10px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n\n        @keyframes fadeOut {\n          from { opacity: 1; transform: translateY(0); }\n          to { opacity: 0; transform: translateY(10px); }\n        }\n\n        @keyframes notifSlideIn {\n          from {\n            opacity: 0;\n            transform: translateX(20px) scale(0.9);\n          }\n          to {\n            opacity: 1;\n            transform: translateX(0) scale(1);\n          }\n        }\n\n        @keyframes notifSlideOut {\n          from {\n            opacity: 1;\n            transform: translateX(0) scale(1);\n          }\n          to {\n            opacity: 0;\n            transform: translateX(20px) scale(0.9);\n          }\n        }\n\n        @media (max-width: 480px) {\n          .va-panel {\n            width: calc(100vw - 40px);\n            right: -10px;\n          }\n        }\n      </style>\n\n      <button class="va-trigger" id="va-trigger" aria-label="Ouvrir l'assistant vocal">\n        <img src="/logo.png" alt="3A" style="width:40px;height:40px;object-fit:contain;border-radius:8px;" />\n      </button>\n\n      <div class="va-panel" id="va-panel">\n        <div class="va-header">\n          <div class="va-header-icon">\n            <img src="/logo.png" alt="3A" style="width:24px;height:24px;object-fit:contain;border-radius:4px;" />\n          </div>\n          <div class="va-header-text">\n            <h3>Assistant 3A</h3>\n            <p>${P?"Écrivez votre question":"Parlez ou écrivez"}</p>\n          </div>\n          <button class="va-close" id="va-close" aria-label="Fermer">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>\n          </button>\n        </div>\n\n        <div class="va-messages" id="va-messages"></div>\n\n        <div class="va-input-area">\n          <input type="text" class="va-input" id="va-input" placeholder="${t}">\n          ${!P&&E?'\n          <button class="va-mic-btn" id="va-mic" aria-label="Activer le micro">\n            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V20h4v2H8v-2h4v-4.07z"/></svg>\n          </button>\n          ':""}\n          <button class="va-send-btn" id="va-send" aria-label="Envoyer">\n            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>\n          </button>\n        </div>\n\n        <div class="va-cta">\n          <a href="/contact.html">Demander un audit gratuit</a>\n        </div>\n      </div>\n    `,document.body.appendChild(e),document.getElementById("va-trigger").addEventListener("click",N),document.getElementById("va-close").addEventListener("click",N),document.getElementById("va-send").addEventListener("click",(()=>{q(document.getElementById("va-input").value)})),document.getElementById("va-input").addEventListener("keypress",(e=>{"Enter"===e.key&&q(e.target.value)})),E&&(function(){if(!E)return;const e=window.SpeechRecognition||window.webkitSpeechRecognition;x=new e,x.lang="fr-FR",x.continuous=!1,x.interimResults=!1,x.onresult=e=>{const n=e.results[0][0].transcript;document.getElementById("va-input").value=n,q(n)},x.onend=()=>{y=!1,document.getElementById("va-mic")?.classList.remove("listening"),document.getElementById("va-trigger").classList.remove("listening")},x.onerror=e=>{console.error("Speech recognition error:",e.error),y=!1,document.getElementById("va-mic")?.classList.remove("listening")}}(),document.getElementById("va-mic").addEventListener("click",R)),async function(){if(!r&&!d)return;if(!m.isSupported())return void console.log("[Realtime] Not supported in this browser");try{await m.connect(),v=!0,g=!0,console.log("[Realtime] Premium voice activated"),m.onAIResponse=e=>{console.log("[Realtime] AI:",e),L();const n=document.getElementById("va-messages"),t=document.createElement("div");t.className="va-message assistant",t.innerHTML=`<div class="va-message-content">${e}</div>`,n.appendChild(t),n.scrollTop=n.scrollHeight,k.push({role:"assistant",content:e})},m.onError=e=>{console.error("[Realtime] Error, falling back to Web Speech:",e),v=!1}}catch(e){console.log("[Realtime] Unavailable, using Web Speech API:",e.message),v=!1,g=!1}}(),setTimeout((()=>{b||function(){const e=document.getElementById("va-trigger"),n=document.createElement("div");n.className="va-notification",n.innerHTML='\n      <div class="va-notif-icon">\n        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>\n        </svg>\n      </div>\n      <div class="va-notif-text">\n        <span class="va-notif-title">Besoin d\'aide ?</span>\n        <span class="va-notif-sub">Je suis là pour vous</span>\n      </div>\n    ',n.style.cssText="\n      position: absolute;\n      bottom: 75px;\n      right: 0;\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      background: rgba(25, 30, 53, 0.95);\n      backdrop-filter: blur(12px);\n      -webkit-backdrop-filter: blur(12px);\n      border: 1px solid rgba(79, 186, 241, 0.3);\n      padding: 12px 16px;\n      border-radius: 12px;\n      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(79, 186, 241, 0.15);\n      animation: notifSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);\n      cursor: pointer;\n      white-space: nowrap;\n      z-index: 9999;\n    ";const t=n.querySelector(".va-notif-icon");t&&(t.style.cssText="\n        width: 32px;\n        height: 32px;\n        background: linear-gradient(135deg, rgba(79, 186, 241, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);\n        border-radius: 8px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        color: #4FBAF1;\n        flex-shrink: 0;\n      ");const o=n.querySelector(".va-notif-text");o&&(o.style.cssText="\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n      ");const s=n.querySelector(".va-notif-title");s&&(s.style.cssText="\n        font-size: 14px;\n        font-weight: 600;\n        color: #E4F4FC;\n        letter-spacing: -0.01em;\n      ");const a=n.querySelector(".va-notif-sub");a&&(a.style.cssText="\n        font-size: 11px;\n        color: rgba(255, 255, 255, 0.7);\n        font-weight: 400;\n      ");const i=document.createElement("div");i.style.cssText="\n      position: absolute;\n      bottom: -6px;\n      right: 24px;\n      width: 12px;\n      height: 12px;\n      background: rgba(25, 30, 53, 0.95);\n      border-right: 1px solid rgba(79, 186, 241, 0.3);\n      border-bottom: 1px solid rgba(79, 186, 241, 0.3);\n      transform: rotate(45deg);\n    ",n.appendChild(i),e.parentNode.appendChild(n),n.addEventListener("mouseenter",(()=>{n.style.borderColor="rgba(79, 186, 241, 0.6)",n.style.boxShadow="0 8px 32px rgba(0, 0, 0, 0.4), 0 0 30px rgba(79, 186, 241, 0.25)"})),n.addEventListener("mouseleave",(()=>{n.style.borderColor="rgba(79, 186, 241, 0.3)",n.style.boxShadow="0 8px 32px rgba(0, 0, 0, 0.3), 0 0 20px rgba(79, 186, 241, 0.15)"})),n.addEventListener("click",N),setTimeout((()=>{n.style.animation="notifSlideOut 0.3s ease forwards",setTimeout((()=>n.remove()),300)}),6e3)}()}),2e3)}function C(e,n="assistant"){const t=document.getElementById("va-messages"),o=document.createElement("div");o.className=`va-message ${n}`,o.innerHTML=`<div class="va-message-content">${e}</div>`,t.appendChild(o),t.scrollTop=t.scrollHeight,"assistant"===n&&z&&function(e){if(v&&m.connected)return void console.log("[Voice] Using Grok Realtime (premium audio)");if(!z)return;w.cancel();const n=new SpeechSynthesisUtterance(e);n.lang="fr-FR",n.rate=1,n.pitch=1,w.speak(n)}(e),k.push({role:"user"===n?"user":"assistant",content:e})}function L(){const e=document.getElementById("va-typing");e&&e.remove()}function R(){x&&(y?x.stop():(x.start(),y=!0,document.getElementById("va-mic").classList.add("listening"),document.getElementById("va-trigger").classList.add("listening")))}async function q(e){if(e.trim()){C(e,"user"),document.getElementById("va-input").value="",function(){const e=document.getElementById("va-messages"),n=document.createElement("div");n.className="va-message assistant",n.id="va-typing",n.innerHTML='<div class="va-message-content"><div class="va-typing"><span></span><span></span><span></span></div></div>',e.appendChild(n),e.scrollTop=e.scrollHeight}();try{if(v&&m.connected)return m.sendText(e),void setTimeout((()=>L()),500);const n=await async function(e){const n=e.toLowerCase();if(I.bookingFlow.active){const n=await async function(e){const n=e.toLowerCase(),t=I.bookingFlow;if(n.includes("annuler")||n.includes("non")||n.includes("stop"))return h("voice_booking_cancelled",{step:t.step}),t.active=!1,t.step=null,t.data={name:null,email:null,datetime:null,service:"Consultation"},"Pas de probleme, reservation annulee. Comment puis-je vous aider autrement ?";if("name"===t.step){const n=e.trim();return n.length<2?"Je n'ai pas compris votre nom. Pouvez-vous me le redonner ?":(t.data.name=n,t.step="email","Merci "+n+" ! Quelle est votre adresse email pour recevoir la confirmation ?")}if("email"===t.step){const n=e.trim().toLowerCase();if(!function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(n))return"Cette adresse email ne semble pas valide. Pouvez-vous la verifier ? (format: exemple@email.com)";t.data.email=n,t.step="datetime";const o=await async function(){const e=Date.now();if(F.slots.length>0&&e-F.timestamp<D)return F.slots;try{const n=await fetch(B+"?action=availability",{method:"GET",mode:"cors"}),t=await n.json();if(t.success&&t.data&&t.data.slots){const n=t.data.slots.slice(0,6).map((e=>({date:new Date(e.start).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),time:e.time,iso:e.start})));return F={slots:n,timestamp:e},n}}catch(e){console.error("Erreur fetch créneaux:",e)}return O()}(),s=o.slice(0,3);return 0===s.length?"Desole, il n'y a pas de creneaux disponibles cette semaine. Envoyez un email a contact@3a-automation.com pour convenir d'un rendez-vous.":"Parfait ! Voici les prochains creneaux disponibles :\n\n"+s.map(((e,n)=>n+1+". "+e.date+" a "+e.time)).join("\n")+"\n\nRepondez avec le numero (1, 2 ou 3) ou proposez une autre date."}if("datetime"===t.step){const e=function(){if(F.slots.length>0)return F.slots.slice(0,3);return O()}();let o=null;return n.includes("1")||n.includes("premier")?o=e[0]:n.includes("2")||n.includes("deux")?o=e[1]:(n.includes("3")||n.includes("trois"))&&(o=e[2]),o?(t.data.datetime=o.iso,t.step="confirm",h("voice_booking_slot_selected",{slot_date:o.date,slot_time:o.time}),"Parfait ! Voici le recapitulatif :\n\nNom: "+t.data.name+"\nEmail: "+t.data.email+"\nDate: "+o.date+" a "+o.time+"\n\nConfirmez-vous ce rendez-vous ? (oui/non)"):"Je n'ai pas compris votre choix. Repondez 1, 2 ou 3 pour choisir un creneau."}if("confirm"===t.step)return n.includes("oui")||n.includes("ok")||n.includes("confirme")?(t.step="submitting",null):"Dites 'oui' pour confirmer ou 'annuler' pour recommencer.";return null}(e);if("submitting"===I.bookingFlow.step)return await async function(){const e=I.bookingFlow,n=function(){if(window.GeoLocale&&"function"==typeof window.GeoLocale.getTimezone)return window.GeoLocale.getTimezone();try{return{iana:Intl.DateTimeFormat().resolvedOptions().timeZone,offset:(new Date).getTimezoneOffset()}}catch(e){return{iana:null,offset:(new Date).getTimezoneOffset()}}}(),t=await async function(e){try{const n=await fetch(B,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(e)});return await n.json()}catch(e){return console.error("Booking error:",e),{success:!1,message:e.message}}}({name:e.data.name,email:e.data.email,datetime:e.data.datetime,service:e.data.service,phone:"",notes:"Reservation via assistant vocal",timezone:n.iana||`UTC${n.offset>0?"-":"+"}${Math.abs(n.offset/60)}`});return e.active=!1,e.step=null,t.success?(h("voice_booking_completed",{service:e.data.service,datetime:e.data.datetime}),"Votre rendez-vous est confirme ! Vous allez recevoir un email de confirmation a "+e.data.email+".\n\nA bientot !"):(h("voice_booking_failed",{error:t.message}),"Desole, il y a eu un probleme : "+t.message+"\n\nVous pouvez reserver directement sur /booking.html")}();if(n)return n}if(function(e){const n=e.toLowerCase();return j.some((e=>n.includes(e)))}(n))return I.bookingFlow.active=!0,I.bookingFlow.step="name",h("voice_booking_started",{step:"name"}),"Super ! Je vais vous aider a reserver un rendez-vous.\n\nPour commencer, quel est votre nom ?";const t=function(e){const n=e.toLowerCase(),t={btp:["btp","construction","batiment","chantier","artisan","renovation","travaux"],ecommerce:["e-commerce","ecommerce","boutique","shopify","vente en ligne","magasin en ligne"],b2b:["b2b","btob","entreprise","professionnel","corporate","industrie"],saas:["saas","software","application","startup","tech","logiciel"],services:["service","prestataire","consultant","agence","freelance","cabinet"],retail:["retail","magasin","point de vente","commerce"]};for(const[e,o]of Object.entries(t))if(o.some((e=>n.includes(e))))return e;return null}(e);t&&(I.industry=t);const o=function(e){const n=e.toLowerCase(),t={leads:["lead","prospect","client","acquisition","prospection","trouver des clients"],email:["email","mail","newsletter","klaviyo","emailing"],analytics:["analytics","données","dashboard","rapport","statistiques","ga4"],automation:["automatiser","automatisation","workflow","gagner du temps"],devis:["devis","prix","tarif","combien","coût","budget"]};for(const[e,o]of Object.entries(t))if(o.some((e=>n.includes(e))))return e;return null}(e);o&&(I.need=o);if($.oui.keywords.some((e=>n.includes(e))))return"processus"===I.lastTopic?"Parfait ! Pour démarrer, rendez-vous sur notre page contact :\n/contact.html\n\nRemplissez le formulaire (5 min) et je vous envoie le rapport sous 24-48h.\n\nDes questions avant de commencer ?":"audit"===I.lastTopic?"Super ! Pour votre audit gratuit :\nRendez-vous sur /contact.html\n\nJe vous envoie le rapport avec 3 recommandations sous 24-48h.\n\nOu envoyez-moi directement un email à contact@3a-automation.com avec le lien de votre site !":"Excellent ! La prochaine étape c'est l'audit gratuit.\n\nRemplissez le formulaire sur /contact.html\nOu email: contact@3a-automation.com\n\nJe vous réponds sous 24h !";for(const[e,t]of Object.entries($))if(t.keywords.some((e=>n.includes(e)))){if(I.lastTopic=e,"leads"===e&&I.industry){const e=V[I.industry];if(e&&e.leads)return e.leads+"\n\nVoulez-vous en savoir plus sur les tarifs ?"}if(t.response)return t.response}if(I.industry){const e=V[I.industry];if(e){if(n.includes("service")||n.includes("automatisation")||n.includes("quoi"))return I.lastTopic="services",e.services+"\n\nQu'est-ce qui vous intéresse le plus ?";if(!k.some((n=>n.content.includes(e.intro.substring(0,30)))))return e.intro+"\n\nQuel est votre besoin principal ?"}}if("devis"===I.need)return I.lastTopic="pricing",$.pricing.response;if(I.industry)return`Pour votre activité ${I.industry.toUpperCase()}, nous pouvons vous proposer plusieurs solutions.\n\nCommençons par l'audit gratuit : nous vous envoyons un rapport personnalisé avec 3 recommandations prioritaires sous 24-48h.\n\nÇa vous intéresse ?`;const s=k.slice(-6).map((e=>({role:"user"===e.sender?"user":"assistant",content:e.content}))),a=await async function(e,n=[]){const t=new AbortController,o=setTimeout((()=>t.abort()),15e3);try{const s=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,history:n}),signal:t.signal});if(clearTimeout(o),!s.ok)throw new Error(`API Error: ${s.status}`);const a=await s.json();if(a.success&&a.response)return console.log(`[Voice] Response from ${a.provider}${a.fallbacksUsed>0?` (${a.fallbacksUsed} fallbacks)`:""}`),{success:!0,response:a.response,provider:a.provider};throw new Error("Invalid API response")}catch(e){return clearTimeout(o),console.log("[Voice] API unavailable, using local patterns:",e.message),{success:!1,error:e.message}}}(e,s);if(a.success)return h("voice_ai_response",{provider:a.provider}),a.response;return"Pour mieux vous aider, pouvez-vous nous dire :\n\n• Quel est votre secteur d'activité ?\n• Quel est votre besoin principal ? (leads, email, analytics...)\n\nOu si vous préférez, demandez directement l'audit gratuit et nous vous recontactons avec des recommandations personnalisées !"}(e);L(),C(n,"assistant")}catch(e){L(),C("Désolé, une erreur est survenue. Veuillez réessayer ou utiliser le formulaire de contact.","assistant")}}}let I={industry:null,companySize:null,need:null,budget:null,stage:"discovery",lastTopic:null,bookingFlow:{active:!1,step:null,data:{name:null,email:null,datetime:null,service:"Consultation"}}};const B="https://script.google.com/macros/s/AKfycbw9JP0YCJV47HL5zahXHweJgjEfNsyiFYFKZXGFUTS9c3SKrmRZdJEg0tcWnvA-P2Jl/exec",j=["rdv","rendez-vous","rendez vous","reserver","reservation","prendre rdv","booking","appel","discuter","parler"];let F={slots:[],timestamp:0};const D=3e5;function O(){const e=new Date,n=[];for(let t=1;t<=7;t++){const o=new Date(e);o.setDate(e.getDate()+t);const s=o.getDay();if(s>=1&&s<=5&&(o.setHours(10,0,0,0),n.push({date:o.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long"}),time:"10:00",iso:o.toISOString()}),n.length>=3))break}return n}const V={btp:{intro:"Pour le BTP, nous proposons des solutions spécifiques : identification de nouveaux prospects, relances automatiques de devis, et demandes d'avis post-travaux.",services:"Automatisations BTP :\n• Identification prospects locaux\n• Veille opportunités automatique\n• Relances devis programmées\n• Emails satisfaction post-travaux\n• Collecte avis clients automatique",leads:"Pour générer des leads BTP, nous identifions automatiquement les opportunités dans votre zone et qualifions les prospects selon vos critères."},b2b:{intro:"Pour le B2B, nous nous concentrons sur la qualification automatique des leads et les séquences de nurturing pour convertir les prospects en clients.",services:"Automatisations B2B :\n• Lead scoring automatique\n• Séquences nurturing personnalisées\n• Synchronisation CRM\n• Alertes commerciales temps réel\n• Qualification automatique",leads:"Pour la génération de leads B2B, nous configurons des workflows de capture et qualification automatique. Les leads chauds déclenchent des alertes en temps réel."},ecommerce:{intro:"Pour l'e-commerce, nous optimisons tout le parcours client : de l'acquisition à la fidélisation, en passant par la récupération des paniers abandonnés.",services:"Automatisations e-commerce :\n• Récupération paniers abandonnés\n• Welcome series nouveaux clients\n• Post-achat pour fidéliser\n• Alertes retour en stock\n• Réactivation clients dormants",leads:"Pour l'e-commerce, nous configurons les flows de conversion pour transformer les visiteurs en acheteurs et maximiser la valeur client."},saas:{intro:"Pour les SaaS, nous configurons l'onboarding automatisé, la prévention du churn, et les emails pour maximiser l'adoption et la rétention.",services:"Automatisations SaaS :\n• Onboarding séquencé\n• Prévention churn proactive\n• Adoption des fonctionnalités\n• Collecte feedback automatique\n• Upsell intelligent"},services:{intro:"Pour les prestataires de services, nous automatisons la prospection, les rappels rendez-vous, et les demandes de témoignages post-mission.",services:"Automatisations services :\n• Prospection automatisée\n• Nurturing leads longs\n• Rappels rendez-vous\n• Demandes de témoignages\n• Suivi administratif"}},$={processus:{keywords:["processus","comment ça marche","fonctionnement","étapes","déroulement","explique"],response:"Voici comment ça se passe :\n\n1. **Formulaire diagnostic** (5 min)\nVous nous décrivez votre activité et vos objectifs\n\n2. **Rapport personnalisé** (24-48h)\nNous vous envoyons 3 recommandations prioritaires\n\n3. **Proposition sur mesure** \nSi ça vous intéresse, devis détaillé adapté à vos besoins\n\n4. **Implémentation clé en main**\nNous configurons tout, vous n'avez rien à faire de technique\n\nPas d'appel obligatoire, tout par écrit si vous préférez !"},pricing:{keywords:["prix","tarif","combien","coût","budget","devis","cher"],response:"Nos tarifs sont forfaitaires, sans surprise :\n\n**PACKS ONE-TIME:**\nDu projet ponctuel au déploiement complet\n\n**RETAINERS MENSUELS:**\nMaintenance et optimisation continue\n\nL'audit est GRATUIT et vous aide à choisir le pack adapté à vos besoins.\n\nConsultez nos tarifs sur /pricing.html ou demandez un devis personnalisé !"},audit:{keywords:["audit","gratuit","diagnostic","analyse"],response:"L'audit est 100% gratuit !\n\n**Ce que vous recevez:**\n• Analyse de vos processus actuels\n• Opportunités d'automatisation identifiées\n• Estimation du ROI potentiel\n• Recommandations personnalisées\n\n**Délai:** 24-48h après le formulaire\n\nVoulez-vous que je vous envoie le lien du formulaire ?"},automatisations:{keywords:["automatisation","automatisations","workflow","flows","quoi automatiser"],response:"Nous proposons un large catalogue d'automatisations :\n\n**Email Marketing:**\nWelcome, Abandon panier, Post-achat, Winback\n\n**Lead Generation:**\nCapture, Scoring, Qualification, Nurturing\n\n**Analytics:**\nDashboards, Alertes, Rapports automatiques\n\n**E-commerce:**\nSync produits, Alertes stock, Reviews\n\n**AI & Video:**\nVidéos marketing, Avatar IA, Voix IA\n\nQuel type vous intéresse le plus ?"},leads:{keywords:["lead","prospect","client","acquisition","trouver des clients"],response:null},difference:{keywords:["différence","pourquoi vous","agence","freelance","avantage"],response:"Ce qui nous différencie :\n\n• **Équipe spécialisée**\nVous travaillez directement avec les experts, pas des commerciaux\n\n• **Prix justes**\nTransparents et compétitifs\n\n• **Spécialisation**\nExperts automation marketing - pas généralistes\n\n• **Résultats mesurables**\nROI prouvé sur chaque projet\n\n• **Flexibilité**\nPas d'engagement long terme obligatoire"},garantie:{keywords:["garantie","risque","marche pas","satisfait"],response:"Notre garantie est simple :\n\n• **Satisfait ou on itère**\nSi les automatisations ne fonctionnent pas comme prévu, nous corrigeons jusqu'à satisfaction.\n\n• **Documentation complète**\nVous gardez le contrôle en toute autonomie.\n\n• **Pas d'engagement**\nLes packs sont one-time. Les abonnements sont résiliables à tout moment.\n\nVoulez-vous commencer par l'audit gratuit pour voir le potentiel ?"},delai:{keywords:["délai","temps","quand","combien de temps","durée"],response:"Les délais varient selon le projet :\n\n• **Projet simple:** 48-72h\n• **Projet standard:** 5-7 jours\n• **Projet complet:** 10-14 jours\n• **Audit gratuit:** 24-48h\n\nCes délais incluent les révisions. Possibilité d'accélérer si urgence."},oui:{keywords:["oui","d'accord","ok","allons-y","intéressé","je veux"],response:null},non:{keywords:["non","pas maintenant","plus tard","je réfléchis"],response:"Pas de problème ! Prenez votre temps. \n\nSi vous changez d'avis, l'audit gratuit reste disponible. Vous pouvez aussi m'envoyer un email à contact@3a-automation.com.\n\nN'hésitez pas à revenir ici si vous avez d'autres questions !"},salutations:{keywords:["bonjour","salut","hello","hi","coucou","bonsoir"],response:"Bonjour ! Je suis l'assistant 3A Automation.\n\nJe peux vous aider à :\n• Automatiser votre marketing (emails, leads)\n• Comprendre nos services\n• Obtenir un audit gratuit\n\nQuel est votre secteur d'activité ?"},remerciements:{keywords:["merci","super","génial","parfait","excellent"],response:"Avec plaisir !\n\nSi vous êtes prêt à passer à l'action, je vous recommande de demander l'audit gratuit — c'est le meilleur moyen de voir concrètement ce qu'on peut faire pour vous.\n\nAutre question ? Je suis là !"}};function N(){b=!b;const t=document.getElementById("va-panel");if(b){if(t.classList.add("open"),0===k.length){C(P?n:e,"assistant")}document.getElementById("va-input").focus()}else t.classList.remove("open"),w&&w.cancel()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",T):T()}();