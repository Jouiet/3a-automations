# 3A Automation - Auto Deploy Website to Hostinger VPS
# Version: 2.1 | Date: 2025-12-19
#
# ARCHITECTURE:
# - Trigger: Push to main affecting landing-page-hostinger/**
# - Method: Direct Hostinger API call with properly formatted JSON
#
# SETUP REQUIRED (one-time):
# 1. GitHub Secrets → HOSTINGER_API_KEY
# 2. GitHub Variables → HOSTINGER_VM_ID (1168256)

name: Deploy Website

on:
  push:
    branches:
      - main
    paths:
      - 'landing-page-hostinger/**'

  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Hostinger VPS

    steps:
      - name: Deploy via Hostinger API
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VM_ID: ${{ vars.HOSTINGER_VM_ID }}
        run: |
          echo "Deploying to Hostinger VPS..."

          # Use heredoc for clean JSON with proper escaping
          cat > /tmp/deploy.json << 'ENDJSON'
          {
            "project_name": "3a-website",
            "content": "services:\n  website:\n    image: nginx:alpine\n    restart: always\n    labels:\n      - traefik.enable=true\n      - traefik.http.routers.website.rule=Host(`3a-automation.com`) || Host(`www.3a-automation.com`)\n      - traefik.http.routers.website.tls=true\n      - traefik.http.routers.website.entrypoints=web,websecure\n      - traefik.http.routers.website.tls.certresolver=mytlschallenge\n      - traefik.http.services.website.loadbalancer.server.port=80\n    networks:\n      - root_default\n    command: sh -c 'apk add --no-cache git && rm -rf /usr/share/nginx/html/* && git clone --depth 1 https://github.com/Jouiet/3a-automations.git /tmp/repo && cp -r /tmp/repo/landing-page-hostinger/* /usr/share/nginx/html/ && rm -rf /tmp/repo && nginx -g \"daemon off;\"'\n\nnetworks:\n  root_default:\n    external: true"
          }
          ENDJSON

          # Call Hostinger API
          RESPONSE=$(curl -s -X POST \
            "https://developers.hostinger.com/api/vps/v1/virtual-machines/${HOSTINGER_VM_ID}/docker" \
            -H "Authorization: Bearer ${HOSTINGER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @/tmp/deploy.json)

          echo "API Response: $RESPONSE"

          # Extract action ID
          ACTION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [ -z "$ACTION_ID" ]; then
            echo "❌ Failed to start deployment"
            echo "$RESPONSE"
            exit 1
          fi

          echo "Deployment started with action ID: $ACTION_ID"
          echo "ACTION_ID=$ACTION_ID" >> $GITHUB_ENV

      - name: Wait for deployment
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VM_ID: ${{ vars.HOSTINGER_VM_ID }}
        run: |
          echo "Waiting for deployment to complete..."

          for i in {1..12}; do
            sleep 10

            STATUS=$(curl -s \
              "https://developers.hostinger.com/api/vps/v1/virtual-machines/${HOSTINGER_VM_ID}/actions/${ACTION_ID}" \
              -H "Authorization: Bearer ${HOSTINGER_API_KEY}" \
              | jq -r '.state')

            echo "Status check $i: $STATUS"

            if [ "$STATUS" = "success" ]; then
              echo "✅ Deployment action completed!"
              break
            elif [ "$STATUS" = "error" ]; then
              echo "❌ Deployment failed"
              exit 1
            fi
          done

      - name: Wait for container startup
        run: |
          echo "Waiting 60 seconds for container to start and pull content..."
          sleep 60

      - name: Verify site
        run: |
          echo "Verifying site is live..."

          HTTP_STATUS=$(curl -sI https://3a-automation.com | head -1 | awk '{print $2}')

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Site is live (HTTP 200)"

            # Verify tracking codes
            if curl -s https://3a-automation.com | grep -q "GTM-WLVJQC3M"; then
              echo "✅ GTM tracking verified"
            else
              echo "⚠️ GTM not found - content may not be fully loaded yet"
            fi
          else
            echo "⚠️ Site returned HTTP $HTTP_STATUS - container may still be starting"
            # Don't fail - the deployment itself succeeded
          fi
