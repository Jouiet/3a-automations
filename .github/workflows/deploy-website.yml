# 3A Automation - Auto Deploy Website to Hostinger VPS
# Version: 4.0 | Date: 2026-01-23
#
# ARCHITECTURE:
# - Trigger: Push to main affecting landing-page-hostinger/**
# - Validation: Design system check BEFORE deployment
# - Method: Direct Hostinger API call with properly formatted JSON
#
# SETUP REQUIRED (one-time):
# 1. GitHub Secrets ‚Üí HOSTINGER_API_KEY
# 2. GitHub Variables ‚Üí HOSTINGER_VM_ID (1168256)

name: Deploy Website

on:
  push:
    branches:
      - main
    paths:
      - 'landing-page-hostinger/**'

  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Design System

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Design System Validation
        run: |
          echo "üîç Running design-auto-fix checks..."
          node scripts/design-auto-fix.cjs --check

          echo "üé® Running core design system validation..."
          node scripts/validate-design-system.cjs --ci

          echo "üîß Running extended design validation (buttons, cards, a11y)..."
          node scripts/validate-design-extended.cjs --ci

          echo "‚úÖ All design validations passed"

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Hostinger VPS
    needs: validate

    steps:
      - name: Deploy via Hostinger API
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VM_ID: ${{ vars.HOSTINGER_VM_ID }}
        run: |
          echo "Deploying to Hostinger VPS..."

          # Use heredoc for clean JSON with proper escaping
          cat > /tmp/deploy.json << 'ENDJSON'
          {
            "project_name": "3a-website",
            "content": "services:\n  website:\n    image: nginx:alpine\n    restart: always\n    labels:\n      - traefik.enable=true\n      - traefik.http.routers.website.rule=Host(`3a-automation.com`) || Host(`www.3a-automation.com`)\n      - traefik.http.routers.website.tls=true\n      - traefik.http.routers.website.entrypoints=web,websecure\n      - traefik.http.routers.website.tls.certresolver=mytlschallenge\n      - traefik.http.services.website.loadbalancer.server.port=80\n      - traefik.http.routers.website.middlewares=security-headers@docker\n      - traefik.http.middlewares.security-headers.headers.stsSeconds=31536000\n      - traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true\n      - traefik.http.middlewares.security-headers.headers.stsPreload=true\n      - traefik.http.middlewares.security-headers.headers.frameDeny=true\n      - traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true\n      - traefik.http.middlewares.security-headers.headers.browserXssFilter=true\n      - traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin\n      - traefik.http.middlewares.security-headers.headers.permissionsPolicy=camera=(), microphone=(), geolocation=(), payment=()\n    networks:\n      - root_default\n    command: sh -c 'apk add --no-cache git && rm -rf /usr/share/nginx/html/* && git clone --depth 1 https://github.com/Jouiet/3a-automations.git /tmp/repo && cp -r /tmp/repo/landing-page-hostinger/* /usr/share/nginx/html/ && cp /tmp/repo/landing-page-hostinger/nginx.conf /etc/nginx/conf.d/default.conf && rm -rf /tmp/repo && nginx -g \"daemon off;\"'\n\nnetworks:\n  root_default:\n    external: true"
          }
          ENDJSON

          # Call Hostinger API
          RESPONSE=$(curl -s -X POST \
            "https://developers.hostinger.com/api/vps/v1/virtual-machines/${HOSTINGER_VM_ID}/docker" \
            -H "Authorization: Bearer ${HOSTINGER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @/tmp/deploy.json)

          echo "API Response: $RESPONSE"

          # Extract action ID
          ACTION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [ -z "$ACTION_ID" ]; then
            echo "‚ùå Failed to start deployment"
            echo "$RESPONSE"
            exit 1
          fi

          echo "Deployment started with action ID: $ACTION_ID"
          echo "ACTION_ID=$ACTION_ID" >> $GITHUB_ENV

      - name: Wait for deployment
        env:
          HOSTINGER_API_KEY: ${{ secrets.HOSTINGER_API_KEY }}
          HOSTINGER_VM_ID: ${{ vars.HOSTINGER_VM_ID }}
        run: |
          echo "Waiting for deployment to complete..."

          for i in {1..12}; do
            sleep 10

            STATUS=$(curl -s \
              "https://developers.hostinger.com/api/vps/v1/virtual-machines/${HOSTINGER_VM_ID}/actions/${ACTION_ID}" \
              -H "Authorization: Bearer ${HOSTINGER_API_KEY}" \
              | jq -r '.state')

            echo "Status check $i: $STATUS"

            if [ "$STATUS" = "success" ]; then
              echo "‚úÖ Deployment action completed!"
              break
            elif [ "$STATUS" = "error" ]; then
              echo "‚ùå Deployment failed"
              exit 1
            fi
          done

      - name: Wait for container startup
        run: |
          echo "Waiting 60 seconds for container to start and pull content..."
          sleep 60

      - name: Verify site
        run: |
          echo "Verifying site is live..."

          HTTP_STATUS=$(curl -sI https://3a-automation.com | head -1 | awk '{print $2}')

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Site is live (HTTP 200)"

            # Verify tracking codes
            if curl -s https://3a-automation.com | grep -q "GTM-WLVJQC3M"; then
              echo "‚úÖ GTM tracking verified"
            else
              echo "‚ö†Ô∏è GTM not found - content may not be fully loaded yet"
            fi
          else
            echo "‚ö†Ô∏è Site returned HTTP $HTTP_STATUS - container may still be starting"
            # Don't fail - the deployment itself succeeded
          fi
